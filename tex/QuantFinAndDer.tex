\documentclass[oneside,titlepage,headinclude,12pt,a4paper,BCOR5mm,footinclude]{book}
\usepackage{pdfpages}
\usepackage[T1]{fontenc}
\usepackage{mathtools}
\usepackage{bbm}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amsthm}
\usepackage{amssymb}
\usepackage{enumitem} 
\usepackage{cancel}
\renewcommand*\rmdefault{ppl}
\setlength{\parindent}{0em}
\setlength{\parskip}{0.5em}
%\theoremstyle{definition}
\newtheoremstyle{defn}
  {\topsep}
  {\topsep}
  {\normalfont}
  {0pt}
  {\bfseries}
  {.}
  {5pt plus 1pt minus 1pt}
  {}
\theoremstyle{defn}
\newtheorem{defn}{Definition}
\newtheorem{example}{Example}
\newtheorem{theo}{Theorem}

\newcommand{\eexp}{\mathrm{e}}
\newcommand{\rnE}[1]{\mathbb{\tilde E}\left[ {#1} \right]}
\newcommand{\rnP}[1]{\mathbb{\tilde P}\left( {#1} \right)}
\newcommand\NN{\mathcal{N}}
\newcommand\de\partial

\title{Quantitative Finance and Derivatives}

\begin{document}

\maketitle
\tableofcontents

\chapter{Models for asset pricing}

\section{Stochastic Processes}

Stochastic  processes are  collections  of random  variables representing  the
evolution of some system over time.  Stochastic processes can have discrete or
continuous values, and can evolve over discrete or continuous time.

We have four different possible situations:
\begin{enumerate}
  \item \(X(n,\omega) : \mathbb{N} \times (\Omega,\mathcal{F},\mathbb{P}) \to \text{a subset of } \mathbb{Z}:\) discrete time, discrete values. For example: a \textit{random walk}.
  \item \(X(n,\omega) : \mathbb{N} \times (\Omega,\mathcal{F},\mathbb{P}) \to \text{a subset of } \mathbb{R}:\) discrete time, continuous values.
  \item \(X(n,\omega) : \mathbb{R}^+ \times (\Omega,\mathcal{F},\mathbb{P}) \to \text{a subset of } \mathbb{Z}:\) continuous time, discrete values. For example: a \textit{Poisson process}.
  \item \(X(n,\omega) : \mathbb{R}^+ \times (\Omega,\mathcal{F},\mathbb{P}) \to \text{a subset of } \mathbb{R}:\) continuous time, continuous values. For example: a \textit{Brownian motion}.
\end{enumerate}

\subsection{From random walk to Brownian motion}

Let   $$(X_n)_{n   \geq    0}$$   be   a   stochastic    process   such   that
\(X_i\),   for   any   \(i\),   can  take   value   \(1\)   with   probability
\(\mathbb{P}(X_i=1)=\frac{1}{2}\),     and     \(-1\)     with     probability
\(\mathbb{P}(X_i=-1)=\frac{1}{2}\). Let then \(S_n = X_1 + X_2 + \ldots +X_n\)
be the  position you  are at  on a  line after  \(n\) steps.  Informally, each
\(X_i\) "moves" you randomly one step to the right or one step to the left. We
want  to know  expectation  and variance  of this  process.  Let's assume  the
\((X_n)_{n \geq  0}\) to be \textit{independent  and identically distributed}.
We can now assert the following:

\[
  E\left[X_i\right] = (+1) \cdot \frac{1}{2} + (-1) \cdot \frac{1}{2} = 0
\]
  
\[
  E\left[X_i^2\right] = (+1)^2 \cdot \frac{1}{2} + (-1)^2 \cdot \frac{1}{2} = 1
\]

Hence,

\[
  E\left[S_n\right] = \sum_{i=1}^n E\left[X_i\right] = 0
\]

\[
  Var\left[S_n\right] = \sum_{i=1}^n E\left[X_i^2\right] = n
\]

As \(n\)  approaches infinity,  the conditions  for the  \textit{Central Limit
Theorem} hold: \(X_i\)s are \textit{i.i.d.}, so we can apply

\[
  \frac{S_n - n \cdot E\left[X_i\right]}{\sqrt{n \cdot Var\left[X_i\right]}}
  = \frac{S_n}{\sqrt{n}} \underset{n \to \infty}{\sim} \mathcal{N}(0,1)
\]

Consider now a non-unitary  time. Suppose we move in time  steps of \(\delta >
0\) and in space steps of \(\sqrt{\delta}\), and let's consider the process in
the interval $[0,t],\ t\in\mathbb{R}^+$. Then,

\[
  S_t = \sum_{i=0}^{\left\lfloor \frac{t}{\delta} \right\rfloor} X_i
\]

where     $X_i$     moves     by     $\pm\sqrt\delta$     with     probability
$\mathbb{P}=\frac{1}{2}$. Then, $E\left[S_t\right]=0$ and

\[
  Var[X_i] = E^2[X_i] - E[X_i^2] = E^2[X_i] = (+\sqrt{\delta})^2 \cdot \frac{1}{2} + (-\sqrt{\delta})^2 \cdot \frac{1}{2} 
    = \delta
\]

\[
  Var[S_t] = \frac{t}{\delta} \cdot \delta = t
\]

Let's now apply \textit{Central Limit Theorem}:

\[
  \frac{S_t - \frac{t}{\delta} E[X_i]}{\sqrt{\frac{t}{\delta} Var[X_i]}}
  = \frac{S_t}{\sqrt{t}} \underset{t \to \infty}{\sim} \mathcal{N}(0,1).
\]

So, $S_t \sim \mathcal{N}(0,t)$: this is the \textit{Brownian motion}.

\begin{defn} 
  \textbf{(Brownian motion).} The stochastic process 

  \[
    (W_t)_{t\in\mathbb{R}^+} : \mathbb{R}^+ \times (\Omega, (\mathcal{F}_t)_{t \geq 0}, \mathbb{P}) \to \mathbb{R}
  \]

  is a Brownian motion if and only if

  \begin{enumerate}[label=(\Roman*)]
    \item $W_0 = 0$,
    \item it is continuous,
    \item  has  stationary  increments:  the distribution  doesn't  depend  on
           initial time, only on waiting time.
      
      $$\forall t > s,\ W_t - W_s \sim \mathcal{N}(0,t-s)$$

    \item has independent increments over disjoint intervals: 
      
      $$\forall q < r < s < t,\ (W_r-W_q) \perp (W_t-W_s).$$
  \end{enumerate}
  \qed
\end{defn}

%\begin{enumerate}
%  \item From Random Walk to Brownian Motion
%  \item Brownian motion definition
%  \item Classifications
%\end{enumerate}

\begin{defn}\textbf{(Classes of Brownian motions.)}

\begin{enumerate}[label=(\Roman*)]
  \item \textit{Standard Brownian motion}, or \textit{Wiener Process}.
  \item \textit{Arithmetic Brownian motion}, or \textit{Bachelier Model}.
    
    \[
      dp_t = p_{t+h} - p_t = \mu dt + \sigma dW_t
    \]

    Where    $\mu$    is    called   \textit{drift},    and    $\sigma$    the
    \textit{volatility}. This is  a \textit{stochastic differential equation},
    \textit{SDE} for short: while the $\mu dt$ part is \textit{deterministic},
    the $\sigma  dW_t$ contains  a \textit{stochastic}  component, which  is a
    standard Brownian motion. This kind of  equations provides a model for the
    change of the  price $p_t$ over the infinitesimal time  increment from $t$
    to $t+h$. The price variation could be equivalently modeled this way:

    \[
      p_t - p_0 = \mu(t-0) + \sigma(W_t - W_0) = \mu t + \sigma W_t
    \]
    
    Noting that 

    \[ 
      E[W_t]  =  0
      \quad \text{and} \quad
      Var[\sigma W_t]  =  E[(\sigma W_t)^2]  = \sigma^2 E[W_t^2] =  \sigma^2 t,
    \]

    we have that, in Bachelier's model, the price  $p_t = \mu t + \sigma W_t +
    p_0$ is a \textit{random variable} distributed like

    \[
      p_t \sim \mathcal{N}(p_0 + \mu t + E[W_t], \sigma^2 t) \equiv
        \mathcal{N}(p_0 + \mu t, \sigma^2 t).
    \]

  \item \textit{Geometric Brownian motion}, or \textit{Black-Scholes model}.

    \[
      dp_t = \mu p_t dt + \sigma p_t dW_t
    \]

    This model is similar to Bachelier's, but acts on a multiplicative instead
    of additive principle. For this model, we will need to find a solution and
    its distribution.

\end{enumerate}
\qed
\end{defn}

\section{It\=o Formula}

Suppose a model for  an underlying asset price dynamics is  given: we know the
form of $dp_t$;  we'll assume Black-Scholes. It is now  natural to assume that
the price  of a  derivative on this  asset is a  \textit{function}, let  it be
$f(p_t)$, of the asset price. How can we get a \textit{stochastic differential
equation} that models the derivative price variation?

Let's evaluate the \textit{Taylor expansion} for $f(p_t)$ like in a deterministic setting.

\[
  f(x) \approx f(x_0) + f'(x_0)(x-x_0) + \frac{1}{2} f''(x_0)(x-x_0)^2 + \varepsilon
\]

where $\varepsilon$  is a  remainder that  goes quickly to  zero. We  will now
discard all  terms in the  approximation that go to  0 faster than  $dt$ does,
thus truncating the approximation to to the first order. Let now $x=p_{t+dt}$,
$x_0 = p_t$ and $dp_t = p_{t+dt} - p_t$

\[
  f(p_{t+dt}) \approx f(p_t) + f'(p_t)(dp_t) + \frac{1}{2} f''(p_t)(dp_t)^2 + \varepsilon
\]

and substitute the increment $dp_t$ with the Black-Scholes model:

\begin{align*}
  f(p_{t+dt}) = & f(p_t) + f'(p_t)(\mu p_t dt + \sigma p_t dW_t) +\\ 
                & \frac{1}{2}f''(p_t)(\mu^2 p_t^2 (dt)^2 + \sigma^2 p_t^2 (dW_t)^2 + 2 \mu \sigma p_t^2 dtdW_t) 
\end{align*}

Since $E[(dW_t)^2] = dt$, we can  assume $dW_t = \sqrt{dt} = (dt)^\frac{1}{2}$
to have order $\frac{1}{2}$. Let's analyze the  orders of all the terms in the
approximation:
\begin{itemize}
  \item $\mu p_t dt$: First order: keep it.
  \item $\sigma p_t dW_t$: Order $\frac{1}{2}$: keep it.
  \item $\mu^2 p_t^2 (dt)^2$: Second order: discard it.
  \item $\sigma^2 p_t^2 (dW_t)^2$: First order, because $(dW_t)^2 = dt$: keep it.
  \item $2 \mu \sigma p_t^2 dtdW_t$: Order $\frac{3}{2}$ because of $dtdW_t$: discard it.
\end{itemize}
The truncated approximation now states that

\[
  f(p_{t+dt}) = f(p_t) + f'(p_t)(\mu p_t dt + \sigma p_t dW_t) + 
  \frac{1}{2} f''(p_t)(\sigma^2 p_t^2 dt). 
\]

The second derivative term of this equation is called \textit{It\=o correction
term}.  The derivative  of  the function  with  respect to  time  can then  be
computed this way:

\[
  df(p_t) = f(p_{t+dt}) - f(p_t) = f'(p_t)(\mu p_t dt + \sigma p_t dW_t) + 
  \frac{1}{2} f''(p_t)(\sigma^2 p_t^2 dt)
\]

Let's now  separate the deterministic terms  from the stochastic terms,  so we
can identify a \textit{drift} and a \textit{volatility} for the model.

\[
  df(p_t) = \left[ f'(p_t)\mu p_t + \frac{1}{2}f''(p_t)\sigma^2 p_t^2\right]dt
    + f'(p_t)\sigma p_t dW_t
\]

\begin{example}
  Let  $f(p_t) =  \ln(p_t)$  be  the price  of  a  derivative instrument  with
  underlying  price  $p_t$;  the  dynamic   for  the  underlying  follows  the
  Black-Scholes model. Apply It\=o's formula to this derivative:

  \begin{align*}
    d\ln(p_t) = & \left[ \frac{1}{p_t} \mu p_t + \frac{1}{2}\left( 
      -\frac{1}{p_t^2}\sigma^2 p_t^2\right)\right]dt +
      \frac{1}{p_t}\sigma p_t dW_t = \\
      = & \left[\mu - \frac{1}{2} \sigma^2 \right]dt + \sigma dW_t
  \end{align*}

  Considering the time interval $[0,t]$, we observe that
  
  \[
    d\ln(p_t) = \ln(p_t) - \ln(p_0) = \left( \mu - \frac{1}{2}\sigma^2 \right)
      (t-0) + \sigma (W_t - W_0)
  \]
  
  and then
  
  \[
    \ln\left(\frac{p_t}{p_0}\right) = \left(\mu -\frac{1}{2}\sigma^2\right)t + \sigma W_t
    \iff
    \frac{p_t}{p_0} = \mathrm{e}^{\left(\mu - \frac{1}{2}\sigma^2\right)t + \sigma W_t}
  \]
  
  which yields the solution
  
  \[
    p_t = p_0 \mathrm{e}^{\left(\mu - \frac{1}{2}\sigma^2\right)t + \sigma W_t}.
  \]
\end{example}

\begin{example}
  Black-Scholes model assumes the \textit{spot risk-free interest rate} $r$ to
  be constant and independent of  maturity. Consider \textit{discounting} as a
  function of time and asset price:

  \[
    f(t;p_t) = \eexp^{-rt}p_t
  \]

  The general It\=o formula for a function of such a form is

  \begin{align*}
    d[f(t;p_t)] = & 
      \frac{\partial f}{\partial p_t} dp_t + 
      \frac{\partial f}{\partial t} dt + 
      \frac{1}{2} \frac{\partial^2 f}{\partial p_t^2} (dp_t)^2 +
      \underbrace{\cancel{\frac{1}{2} \frac{\partial^2 f}{\partial t^2} (dt)^2}}_\text{order 2} +
      \underbrace{\cancel{\frac{1}{2} \frac{\partial^2 f}{\partial p_t \partial t} 2dtdp_t}}_\text{order 3/2}
      \\
      = & 
      \frac{\partial f}{\partial p_t} dp_t + 
      \frac{\partial f}{\partial t} dt + 
      \frac{1}{2} \frac{\partial^2 f}{\partial p_t^2} \sigma^2 p_t^2dt
  \end{align*}

  For the discounting function, this means

  \begin{align*}
    d[e^{-rt}p_t] = & \eexp^{-rt} \cdot 1 \cdot dp_t + -r\eexp^{-rt}p_tdt +
      \cancelto{0}{\frac{1}{2} \cdot 0 \cdot \sigma^2 p_t^2 dt}
      \\
      = & \eexp^{-rt}\left( \mu p_t dt + \sigma p_t dW_t -r p_t dt \right)
      \\
      = & (\mu - r) \eexp^{-rt} p_tdt + \eexp^{-rt} p_t\sigma dW_t
      \\
    d\tilde{p}_t = & (\mu - r)\tilde{p}_tdt + \sigma \tilde{p}_t dW_t
  \end{align*}

  Hence, the distribution for a discounted asset price follows Black-Scholes model:

  \begin{align*}
    \tilde{p}_t = \tilde{p}_0 \eexp^{(\mu - r - \frac{\sigma^2}{2})t + \sigma W_t}
  \end{align*}

  Note that the  deterministic and stochastic parts were  grouped together, to
  underline the \textit{risk factor}.
\end{example}

\section{Black-Scholes PDE for option pricing} 

In the context of option pricing, Black-Scholes model assumes the following:

\begin{itemize}
  \item $p_t$ is the underlying asset price at time $t$,
  \item $r$ is a constant, risk-free interest rate,
  \item There are no transaction costs, no taxes, and no arbitrage opportunity,
  \item The market is liquid, and so all the instruments,
  \item $f(t;p_t)$ is the option price.
\end{itemize}

By It\=o's lemma, we get that the option price is

\[
  df(t;p_t) = \left[ \frac{\partial f}{\partial t}} + \frac{\partial f}{\partial p_t} \mu p_t +
    \frac{1}{2}\frac{\partial^2 f}{\partial p_t^2} \sigma^2 p_t^2 \right] dt +
    \frac{\partial f}{\partial p_t} \sigma p_t dW_t
\]

Construct a \textit{locally} risk-free portfolio, $\Pi_t$, such that

\[
  \Pi_t = \left\{ 
    \begin{array}{cl}
      -1 & \text{positions in options (short)} \\
      \Delta_t \equiv \frac{\partial f}{\partial p_t} & \text{positions in underlying (long)}
    \end{array}
\]

and study  the dynamics of  the portfolio value  by multiplying the  number of
positions by the dynamics for each kind of instrument (option and asset).

\begin{align*}
  d\Pi_t = & -1 \cdot df(t;p_t) + \frac{\partial f}{\partial p_t} dp_t
  \\ = & \underbrace{- \left[
      \frac{\partial f}{\partial t} + \frac{\partial f}{\partial p_t} \mu p_t +
      \frac{1}{2} \frac{\partial^2 f}{\partial p_t^2} \sigma^2 p_t^2 \right] dt -
      \frac{\partial f}{\partial p_t}\sigma p_t dW_t}_\text{option} +
    \underbrace{
      \frac{\partial f}{\partial p_t} \left( \mu p_t dt + \sigma p_t dW_t \right)
    }_\text{asset}
  \\ = & - \left[
      \frac{\partial f}{\partial t} + 
      \frac{1}{2} \frac{\partial^2 f}{\partial p_t^2} \sigma^2 p_t^2 \right] dt -
      \cancel{\frac{\partial f}{\partial p_t} \mu p_t dt} -
      \cancel{\frac{\partial f}{\partial p_t}\sigma p_t dW_t}
      + \cancel{\frac{\partial f}{\partial p_t} \mu p_t dt} + 
      \cancel{\frac{\partial f}{\partial p_t} \sigma p_t dW_t}
  \\ = & - \left( \frac{\partial f}{\partial t} + 
    \frac{1}{2}\frac{\partial^2 f}{\partial p_t^2} \sigma^2 p_t^2 \right) dt
\end{align*}

Having removed  the Brownian motion,  we are left  without any risky  term. We
impose now the  \textit{no arbitrage assumption}, stating that  a portfolio is
risk-free if  and only  if its dynamics  is the  same of a  bond, that  is, it
accrues interest at a constant (by assumption) rate over time.

\[
  d\Pi_t \equiv - \left( \frac{\partial f}{\partial t} + 
    \frac{1}{2}\frac{\partial^2 f}{\partial p_t^2} \sigma^2 p_t^2 \right) dt 
    \stackrel{\text{NAA}}{=} r\Pi_t dt
\]

\[
  -\frac{\de f}{\de t} -\frac{1}{2}\frac{\de^2f}{\de p_t^2} \sigma^2 p_t^2 =
  -rf(t;p_t) + \frac{\de f}{\de p_t} rp_t
\]

Finally, we obtain the Black-Scholes PDE by rearranging.

\[
  rf(t;p_t) = \frac{\de f}{\de t} + \frac{\de f}{\de p_t} rp_t + \frac{1}{2}\frac{\de^2 f}{\de p_t^2} \sigma^2 p_t^2
\]

The objective  is to  establish the  \textit{fair} (or  \textit{no arbitrage})
price of an option today, that  is, $f(0;p_0)$. A \textit{final condition} can
be imposed:  $f(T,p_T)$, which  is the \textit{option  price at  maturity} or,
equivalently, the \textit{payoff}, which is known.

\[
  f(T;p_T) \stackrel{e.g.}{=}
  \begin{array}{ll}
    (P_T - K)^+ = \max \{ P_T - K, 0 \} & \text{European call option} \\
    (K - P_T)^+ = \max \{ K - P_T, 0 \} & \text{European put option}
  \end{array}
\]

European  options  satisfy  Black-Scholes   assumptions:  the  payoff  depends
\textit{only}  on the  price of  the underlying  at time  $T$, and  it is  not
\textit{path dependent}. The drift term $\mu$ does not appear in Black-Scholes
PDE, and neither  does in the payoff function $f(t;p_t)$;  this means that the
Black-Scholes option  price doesn't depend on  it. The drift term  is strongly
linked  to investor's  \textit{risk aversion}:  this means  the option  can be
priced \textit{as if} the investor is \textit{risk neutral}.

A \textit{risk neutral}  valuation intuitively means that we are  pricing in a
world where every investor behaves as if  he himself is risk neutral; the real
world is not risk neutral, though, and investors' risk aversion is embedded in
the \textit{historical} data.

A \textit{risk neutral} valuation of current option price, given payoff $f(T,p_T)$, is

\[
  f(0;p_0) = \tilde{\mathbb{E}} \left[ e^{-rT} f(T;p_T)\right]
\]

Where $\tilde{\mathbb{E}}$  is the  expectation according to  the \textit{risk
neutral  probability}   $\tilde{\mathbb{P}}$.  We  now  have,   in  fact,  two
probability  spaces: the  first is  the \textit{historical  probability space}
$(\Omega,\mathcal{F},\mathbb{P})$,  the  second  is the  \textit{risk  neutral
probability  space}   $(\Omega,  \mathcal{F},   \tilde{\mathbb{P}})  \supseteq
(\Omega,\mathcal{F},\mathbb{P})$. To  calculate the option price  at any given
time $t : 0 <  t < T$ the information in the filtration up  to time $t$ can be
used:

\[
  f(t;p_0) = \tilde{\mathbb{E}} \left[ e^{-r(T-t)} f(T;p_t) \left| \mathcal{F}_t\right]
\]

\begin{theo} 
  If, in time $t: 0 \leq t \leq T$ the payoff is $(P_T - K)^+$, the price of an option
  at time $t$ is
  
  \[
    C(\tau = T-t, p_t, K, r, \sigma) = f(t;p_t) = p_t \mathcal{N}(d_1) - K\eexp^{-r\tau} \mathcal{N}(d_2)
  \]

  where

  \begin{align*}
    d_1 &= \frac{\ln\left(\frac{p_t}{K}\right) + \left(r + \frac{\sigma^2}{2}\right)(T-t)}{\sigma \sqrt{T-t}}
    \\
    d_2 &= \frac{\ln\left(\frac{p_t}{K}\right) + \left(r - \frac{\sigma^2}{2}\right)(T-t)}{\sigma \sqrt{T-t}} = d_1 - \sigma\sqrt{T-t}
  \end{align*}
\end{theo}

\textit{Proof}. Suppose  we are in  a Black-Scholes  world: we have  one risky
asset with dynamics such that $dp_t = \mu p_t dt + \sigma p_t d\tilde{W}_t$, a
riskless asset  with dynamics  such that  $dB_t = rB_t  dt$, and  no arbitrage
opportunities.  Define  $\tilde{W}_t  =  W_t  +  \frac{\mu-r}{\sigma}t$  where
$\mu-r$  is  the  \textit{risk  premium}  and  $\frac{\mu-r}{\sigma}$  is  the
\textit{market price of risk}. Hence,

\begin{align*}
  dp_t & = rp_t dt + \sigma p_t \left[ dW_t + \frac{\mu-r}{\sigma}dt \right]
  \\ & = \cancel{rp_tdt} + \sigma p_t dW_t + \mu p_t dt - \cancel{rp_t dt}
  \\ & = \mu p_t dt + \sigma p_t dW_t
\end{align*}

Note  that $\tilde{W}_t  \sim \mathcal{N}\left(  \frac{\mu-r}{\sigma}\Delta t;
\Delta t\right)$ is no longer a standard  Brownian motion. We want to know the
option price at  time $t=0$, considering, for example, the  payoff $f(T;p_T) =
(p_T - K)^+$:

\begin{align*}
  C_0 & = f(0;p_0) = \mathbb{\tilde E}\left[\eexp^{-rT} (p_T - K)^+\right]
  \\ & \stackrel{\text{Markov}}{=} \mathbb{\tilde E}\left[ \eexp^{-rT} \left( 
  p_0 \eexp^{\left(r-\frac{\sigma^2}{2}\right)T + \sigma \tilde{W}_T}
  -K\right)^+\right] = (*)_1
\end{align*}
 
Consider now that, if $X  \sim \mathcal{N}(0,T)$ and $Y \sim \mathcal{N}(0,1)$
then $X = \sqrt{T}Y$:

\begin{align*}
  (*)_1 & = \mathbb{\tilde E}\left[ \eexp^{-rT} \left(p_0 \eexp^{\left(r-\frac{\sigma^2}{2}\right)T + \sigma\sqrt{T}Y}-K\right)^+\right]
  \\ & = \int_{-\infty}^{+\infty} \eexp^{-rt} \left(p_0 \eexp^{\left(r-\frac{\sigma^2}{2}\right)T + \sigma\sqrt{T}y}-K\right)^+
  \frac{1}{\sqrt{2\pi}} \eexp^{\frac{-y^2}{2}}dy = (*)_2
\end{align*}

We compute the integral only where the payoff is positive, that is, where

\begin{align*}
  p_0 \eexp^{\left(r-\frac{\sigma^2}{2}\right)T + \sigma\sqrt{T}y} \geq K
  & \iff
  \eexp^{\left(r-\frac{\sigma^2}{2}\right)T + \sigma\sqrt{T}y} \geq \frac{K}{p_0}
  \\ & \iff \left(r-\frac{\sigma^2}{2}\right)T + \sigma\sqrt{T}y \geq \ln\frac{K}{p_0}
  \\ & \iff y \geq \frac{-\ln\frac{p_0}{K} -\left(r - \frac{\sigma^2}{2}\right)T}{\sigma\sqrt{T}} = -d_2
\end{align*}

\begin{align*}
  (*)_2 & = \int_{-d_2}^{+\infty} \eexp^{-rt} \left( p_0 \eexp^{\left(r-\frac{\sigma^2}{2}\right)T + \sigma y\sqrt{T}}-K\right)
    \frac{1}{\sqrt{2\pi}} \eexp^{-\frac{y^2}{2}} dy
    \\ & = \int_{-d_2}^{+\infty} \frac{p_0 \eexp^{-\frac{\sigma^2}{2} + \sigma y\sqrt{T} -\frac{y^2}{2}}}{\sqrt{2\pi}} dy
    - \int_{-d_2}^{+\infty} \frac{K\eexp^{-rt -\frac{y^2}{2}}}{\sqrt{2\pi}}dy
    \\ & = p_0 \int_{-\infty}^{d_2} \frac{1}{\sqrt{2\pi}} \eexp^{-\frac{(\sigma\sqrt{T}+y)^2}{2}}dy
    - K\eexp^{-rt}\int_{-d2}^{+\infty} \frac{1}{\sqrt{2\pi}} \eexp^{-\frac{y^2}{2}} dy
    \\ & \left(\text{Let } z=y+\sigma\sqrt{T} \text{ s.t. } -\infty\leq z \leq d_2+\sigma\sqrt{T}\right)
    \\ & = p_0 \int_{-\infty}^{d_2+\sigma\sqrt{T}} \frac{1}{\sqrt{2\pi}} \eexp^{-\frac{z^2}{2}} dz
    - K\eexp^{-rt}\int_{-\infty}^{d_2} \frac{1}{\sqrt{2\pi}} \eexp^{-\frac{y^2}{2}} dy
    \\ & = p_0 \mathcal{N}(d_2 + \sigma\sqrt{T}) - K\eexp^{-rt} \mathcal{N}(d_2)
    \\ & = p_0 \mathcal{N}(d_1) - K\eexp^{-rt}\mathcal{N}(d_2).
\end{align*}

\section{Cox-Ross-Rubinstein model} 

This model is the equivalent, in  discrete time, of Black-Scholes. CRR accepts
the assumptions of  one risky asset, one riskless asset  and no arbitrage. The
discrete time implies  the underlying is modeled using  a discrete probability
distribution: the Binomial model.

\subsection{Single period model}

In a simple, single period model, the asset can go up in value of a percentage
$u$  with probability  $p$  or go  down  in  value of  a  percentage $d$  with
probability $1-p$.

\[
  S_0 \left\{ \begin{array}{lc}
      S_1^u = uS_0 & p \\ S_1^d= dS_0 & 1-p
    \end{array}
  \quad\quad
  C_0 \left\{ \begin{array}{lc}
      C_u = (uS_0 -K)^+ & p \\ C_d = (dS_0 - K)^+ & 1-p
    \end{array}
\]

The percentages are related like this: $u > 1 + r > 1 > d \geq 0$.

Again, construct  a risk-free portfolio  using the underlying and  the option.
For  the portfolio  to be  risk-free, its  payoff must  be the  same for  each
possible state of the world.

\begin{align*}
  \Pi = \left\{ \begin{array}{cl}
      -1 & \text{option (short)} \\
      \Delta & \text{underlying (long)}
    \end{array}
\end{align*}

\begin{align*}
  \Pi \text{ is risk-free } \iff -C_u + \Delta uS_0 = -C_d + \Delta dS_0
  \iff \Delta = \frac{C_u-C_d}{S_0(u-d)}
\end{align*}

So, $\Delta$  is the quantity  of stock  to be held  so that the  portfolio is
risk-free. Now impose  the no arbitrage assumption: assert  that the risk-free
portfolio in any of the two states of the world after one period must have the
same payoff  as the  portfolio at  initial time  capitalized for  the interest
rate.

\begin{align*}
  -C_u + \Delta uS_0 \stackrel{NAA}{=} (1 + r)(-C_0 + \Delta S_0)
\end{align*}

\begin{gather*}
  -C_u + \frac{C_u - C_d}{\cancel{S_0}(u-d)}\cancel{S_0}u =
  (1+r)\left(-C_0 + \frac{C_u - C_d}{\cancel{S_0}(u-d)}\cancel{S_0}\right) \Rightarrow
  \\
  \frac{-C_u(u-d) + (C_u - C_d)u}{u-d} = -C_0(1+r) + \frac{(1+r)(C_u-C_d)}{u-d} \Rightarrow
  \\
  \frac{C_u(u-d)+(C_u-C_d)(1+r-u)}{u-d} = C_0(1+r) \Rightarrow
  \\
  C_0 = \frac{1}{1+r} \left( C_u \frac{1+r-d}{u-d} + C_d \frac{-1-r+u}{u-d} \right) \Rightarrow
  \\
  C_0 = \frac{1}{1+r} \left(C_u p + C_d(1-p)\right) \quad \text{ where } \quad p = \frac{1+r-d}{u-d}
\end{gather*}

Due to  the previously  imposed relationships  between $u$,  $d$ and  $r$, $p$
respects positivity and can be used as a \textit{risk neutral probability}.

\begin{gather*}
  \mathbb{\tilde E}[S_1] = (uS_0)p + (dS_0)(1-p) = uS_0 \frac{1+r-d}{u-d} + dS_0 \frac{u-1-r}{u-d} =
  \\ \frac{u + ur - ud + du -d -dr}{u-d}S_0 = \frac{(u-d)(1+r)}{u-d}S_0 = (1+r)S_0
\end{gather*}

\subsection{Two-period model}

In a two-period CRR model, we have a \textit{recombining tree}, that is, up-down
and down-up movements yield the same result.

\begin{gather*}
  S_0 \left\langle 
    \begin{array}{ll}
      uS_0 & \left\langle 
        \begin{array}{l}
          u^2S_0 \\
          udS_0
        \end{array} 
      \\
      dS_0 & \left\langle
        \begin{array}{l}
          duS_0 \\
          d^2 S_0
        \end{array} 
    \end{array} 
  \quad\quad
  C_0 \left\langle 
    \begin{array}{ll}
      C_u & \left\langle 
        \begin{array}{l}
          C_{uu} = (u^2S_0-K)^+ \\
          C_{ud} = (udS_0-K)^+
        \end{array} 
      \\
      C_d & \left\langle
        \begin{array}{l}
          C_{du} = (duS_0-K)^+ \\
          C_{dd} = (d^2S_0-K)^+
        \end{array} 
    \end{array} 
\end{gather*}

To obtain the option  price $C_0$ in this case, the idea  is to simply backtrack
from the last period, calculating the discounted $C_u$ and $C_d$ first.

\begin{gather*}
  C_u \left\langle 
    \begin{array}{l}
      C_{uu} = (u^2S_0-K)^+ \\
      C_{ud} = (udS_0-K)^+
    \end{array} 
  \implies
  C_u = \frac{1}{1+r}(C_{uu} p + C_{ud}(1-p))
  \\
  C_d \left\langle
    \begin{array}{l}
      C_{du} = (duS_0-K)^+ \\
      C_{dd} = (d^2S_0-K)^+
    \end{array} 
  \implies
  C_d = \frac{1}{1+r}(C_{du} p + C_{dd}(1-p))
\end{gather*}

Finally, we compose these results by computing

\begin{gather*}
  C_0 \left\langle
    \begin{array}{l}
      C_u \\
      C_d 
    \end{array} 
  \implies
  C_0 = \frac{1}{1+r} (C_up + C_d(1-p)) \\
  = \frac{1}{(1+r)^2} \left( C_{uu}p^2 + C_{ud}p(1-p) + C_{du}p(1-p) + C_{dd}(1-p)^2 \right) \\
  = \frac{1}{(1+r)^2} \left(C_{uu}p^2 + 2C_{ud}p(1-p) + C_{dd}(1-p)^2 \right)
\end{gather*}

\subsection{$n$-period model}

Generalizing to $n$  periods, we have a  $\sim \mathcal{B}(n,p)$ model; any  given path on
the binomial  tree over  the $n$ periods  can have  $j: 0 \leq  j \leq  n$ steps
up  and  $n-j$  steps  down  for  the  underlying's  price,  with  a  payoff  of

\[ (u^jd^{n-j}S_0 -K)^+ \] 

for an option  on the underlying. Following  the same reasoning as  per the two-
and one-period model, we compute the option price as

\begin{gather*}
  C_0 = \frac{1}{(1+r)^n} \sum_{j=0}^n \left( u^j d^{n-j} S_0 - K \right)^+ \binom{n}{j} p^j(1-p)^{n-j} \\
  \text{(let } a \text{ s.t. } \forall j \geq a \quad u^jd^{n-j}S_0 - K > 0 \text{)} \\
  = \frac{1}{(1+r)^n} \sum_{j=a}^n \left( u^j d^{n-j} S_0 - K \right)^+ \binom{n}{j} p^j(1-p)^{n-j} \\
  = \frac{1}{(1+r)^n} \left[\sum_{j=a}^n \binom{n}{j}p^j(1-p)^{n-j}u^jd^{n-j}S_0 -K\sum_{j=a}^n \binom{n}{j}p^j(1-p)^{n-j}\right] \\
  = \sum_{j=a}^n \binom{n}{j}\left(\frac{pu}{1+r}\right)^j \left(\frac{(1-p)d}{1+r}\right)^{n-j}S_0 - \frac{1}{(1+r)^n}K\mathcal{B}_{(n,p)}(j\geq a) \\
  = S_0 \mathcal{B}_{\left(n, \frac{pu}{1+r}\right)}(j \geq a)- \frac{1}{(1+r)^n}K\mathcal{B}_{(n,p)}(j\geq a).
\end{gather*}

Note  that $\frac{pu}{1+r}$  is  a  probability because  it  is  positive by  no
arbitrage assumption  and sums to  $1$ with $\frac{(1-p)d}{1+r}$. Note  that the
equation looks  very similar  to Black-Scholes,  with the  Binomial distribution
instead of the Normal.

\section{Martingale}

Let $S_1$ be the stock  price tomorrow. Under \textit{risk neutral probability},
this should be equal to the stock price today capitalized for the given interest
rate:

\[
  \mathbb{\tilde E} [S_1] = (1+r)S_0
\]

Dividing  both  sides  by  $(1+r)$,   we  obtain  that  the  expectation  (under
\textit{risk neutral probability}) of the  stock price tomorrow ($t=1$) is equal
to the stock price today ($t=0$).

\[
  \mathbb{\tilde E}\left[ \frac{1}{(1+r)^1} S_1 \right] = \frac{1}{(1+r)^0} S_0 \equiv S_0
\]

This is a \textit{martingale}: in such  a process, the expectations through time
are constant.  A martingale is  a \textit{fair game} (in  game-theoretic sense),
that is,  it has zero  drift. The stock  market is not a  fair game in  the real
world, but in a risk neutral world it is.

\begin{defn}\textbf{(Martingale).} 
  Let  $(\Omega,\mathcal{F},\mathbb{P})$ be  a  probability  space. The  process
  $(M_t)_{t\geq 0}$ is a \textit{martingale} if the expectation at a future time
  $t$ given the information  up to time $s$ is equal to  the expectation at time
  $s : 0 \leq s \leq t \leq T$.

  \[
    \mathbb{E}[M_{t} | \mathcal{F}_s] = \mathbb{E}[M_s]
  \]

  Equivalently,
  
  \[
    \mathbb{E}[M_{s+ds} | \mathcal{F}_s] = M_s 
    \implies
    \mathbb{E}[M_{s+ds}] = \mathbb{E}[M_{s}] 
  \]
  \qed
\end{defn}

\begin{example} The Brownian motion is a martingale.

  \textit{Proof}.  Let  $(W_t)_{t\geq 0}$  be  a  Brownian Motion  in  $(\Omega,
  \mathcal{F}, \mathbb{P})$.

  \[
    \mathbb{E}[W_t|\mathcal{F}_s] = W_s,\ s < t \implies
    \mathbb{E}[W_t-W_s|\mathcal{F}_s] = 0
  \]

  From  the  definition  of  Brownian motion,  and  its  independent  increments
  property, follows

  \[
    \mathbb{E}[W_t-W_s|\mathcal{F}_s] = \mathbb{E}[W_t-W_s] \stackrel{\mathcal{N}(0,\sigma)}{=} 0
  \]
  \qed
\end{example}

\section{Pricing exotic options}

The  generic process  of pricing  an  option involves  discounting the  option's
payoff at maturity given a model for the underlying.

\subsection{Digital call option}

The  payoff  for a  \textit{digital  call  option} is  $H$  when  the option  is
\textit{in the money}, $0$ otherwise:

\[
  D_T = \left\{ \begin{array}{cl}
      H & \text{if } p_t \geq K \\
      0 & \text{otherwise}
    \end{array}
\]

Let $dp_t  = (r-q)p_tdt  + \sigma  p_t dW_t$  be the  model for  the underlying,
$t:0\leq  t\leq T$  the current  time and  $T$ the  maturity. The  price of  the
digital option at time $t$ under the risk neutral measure is

\[
  D_t = \mathbb{\tilde E}\left[ \eexp^{-r(T-t)}H \mathbbm{1}_{(p_T \geq K)} |\mathcal{F}_t \right]
      = \eexp^{-r(T-t)}H \mathbb{E}\left[ \mathbbm{1}_{(p_T \geq K)} | \mathcal{F}_t\right]
      = \cdots
\]

Knowing  that  $\mathbb{E}[\mathbbm{1}_A] =  1  \cdot  \mathbb{P}(A) +  0  \cdot
\mathbb{P}(A^C) = \mathbb{P}(A)$,  we can replace the expectation  with the risk
neutral probability;  then, for the  Markov property of Black-Scholes  model, we
replace the  filtration with  the information  known at time  $t$, that  is, the
underlying price.

\[
  \cdots = \eexp^{-r(T-t)}H \mathbb{\tilde P}(p_T \geq K | \mathcal{F}_t)
        = \eexp^{-r(T-t)}H \mathbb{\tilde P}(p_T \geq K | p_t) = \cdots
\]

By It\=o's lemma, we can express the price at maturity $p_T$ as

\[
  p_T = p_t \eexp^{\left(r-q-\frac{\sigma^2}{2}\right)(T-t) + \sigma(W_T-W_t)}
\]

Also, let $Y : Y\sqrt{T-t} = W_T-W_t$. Then,

\begin{align*}
  \cdots &= \eexp^{-r(T-t)}H \mathbb{\tilde P}\left( p_t \eexp^{\left(r-q-\frac{\sigma^2}{2}\right)(T-t) +\sigma(W_T-W_t)} \geq K\right)
  \\&= \eexp^{-r(T-t)}H \mathbb{\tilde P}\left( p_t \eexp^{\left(r-q-\frac{\sigma^2}{2}\right)(T-t) +\sigma Y\sqrt{T-t}} \geq K\right)
  \\&= \eexp^{-r(T-t)}H \mathbb{\tilde P}\left(Y \geq -\frac{\ln\frac{p_t}{K} + \left(r-q-\frac{\sigma^2}{2}\right)(T-t)}{\sigma\sqrt{T-t}}\right)
  \\&= \eexp^{-r(T-t)}H \mathbb{\tilde P}(Y \geq -d_2) 
  \\&= \eexp^{-r(T-t)}H \mathcal{N}(-d_2)
\end{align*}

\subsection{Asset-or-nothing call option}

The payoff for an \textit{asset-or-nothing} call option is $p_T$ when the option
is \textit{in the money}, $0$ otherwise:

\[
  A_T = \left\{ \begin{array}{cl}
      p_T & \text{if } p_t \geq K \\
      0 & \text{otherwise}
    \end{array}
\]

The \textit{asset-or-nothing} option price at present time $t$ is then computed as

\begin{align*}
  A_t &= \rnE{ \eexp^{-r(T-t)} p_T \mathbbm{1}(p_T \geq K) | \mathcal{F}_t }
  \\&= \eexp^{-r(T-t)} \rnE{ p_T \mathbbm{1}(p_T \geq K) | \mathcal{F}_t }
       \stackrel{\small Markov}{=}
       \eexp^{-r(T-t)} \rnE{ p_T \mathbbm{1}(p_T \geq K) | p_t } = \cdots
\end{align*}

$p_T$ is  a \textit{random variable};  its expectation can be  computed, knowing
its  distribution,  by  integrating.  The  indicator  function  means  that  the
expectation for  $p_T$ can be  computed only over the  part where $p_T  \geq K$,
that is, past $d_2$.

\begin{align*}
  \cdots &= \eexp^{-r(T-t)} \int_{-d_2}^\infty p_t \eexp^{\left(r-q-\frac{\sigma^2}{2}\right)(T-t)+\sigma (W_T-W_t)} 
            \cdot \frac{\eexp^{-\frac{y^2}{2}}}{\sqrt{2\pi}} dy
  \\&= \int_{-d_2}^\infty p_t \eexp^{\left(r-r-q-\frac{\sigma^2}{2}\right)(T-t)+\sigma (W_T-W_t)} 
       \cdot \frac{\eexp^{-\frac{y^2}{2}}}{\sqrt{2\pi}} dy
   \\&= p_t \eexp^{-q(T-t)} \int_{-d_2}^\infty \frac{\eexp^{-\frac{\sigma^2}{2}+\sigma y\sqrt{T-t}-\frac{y^2}{2}}}{\sqrt{2\pi}} dy
   \\&= p_t \eexp^{-q(T-t)} \int_{-d_2}^\infty \frac{\eexp^{-\frac{(\sigma\sqrt{T-t} + y)^2}{2}}}{\sqrt{2\pi}} dy = \cdots
\end{align*}

Now  we flip  the integration  domain thanks  to Normal  distribution's symmetry
property and then  integrate by substituting $z : z(y)  = \sigma\sqrt{T-t} + y$;
the new integration domain extremes are  then $z(-\infty) = -\infty$ and $z(d_2)
= d_2 + \sigma\sqrt{T-t} = d_1$.

\begin{align*}
  \cdots &= p_t \eexp^{-q(T-t)} \int_{-\infty}^{d_1} \frac{\eexp^{-\frac{z^2}{2}}}{\sqrt{2\pi}} dz
  \\&= p_t \eexp^{-q(T-t)} \mathcal{N}(d_1).
\end{align*}

\section{Equivalence of PDEs with Risk Neutral Valuation}

Do PDEs  and risk  neutral valuation  yield the same  value for  the price  of a
derivative instrument? Suppose $f(t;p_t)$ satisfies Black-Scholes PDE:

\[
  \frac{\de f}{\de t} + rp_t\frac{\de f}{\de p_t} + \frac{1}{2} \frac{\de^2 f}{\de p_t^2}\sigma p_t^2 = rf(t;p_t)
\]

We need to check if the price arising from risk neutral valuation is the same:

\[
  f(t;p_t) = \rnE{e^{-r(T-t)} \cdot \text{payoff} | \mathcal{F}_t}
\]

\begin{example} Given the option price $f$, apply It\=o to get the discounted option price.

\begin{align*}
  d\left[ f(t;p_t) \eexp^{-rt}\right] &= -r\eexp^{-rt} fdt + \eexp^{-rt} df + 0
  \\&= -r\eexp^{-rt} fdt + \eexp^{-rt} \left( \frac{\de f}{\de t} dt + \frac{\de f}{\de p_t} rp_tdt+ \frac{\de f}{\de p_t} \sigma p_t dW_t + 
       \frac{1}{2}\frac{\de^2 f}{\de p_t^2} \sigma^2p_t^2dt \right)
  \\&= \eexp^{-rt}dt \left( \cancel{-rf} + \cancel{\frac{\de f}{\de t} + \frac{\de f}{\de p_t} rp_t + \frac{1}{2} \frac{\de^2 f}{\de p_t^2} \sigma^2 p_t^2}\right)
       + \eexp^{-rt} \frac{\de f}{\de p_t}\sigma p_t dW_t
  \\&= \eexp^{-rt} \frac{\de f}{\de p_t}\sigma p_t dW_t
\end{align*}

We now note that the discounted option price lacks a drift, and is thus a \textit{martingale}: hence, 

\[
  \rnE{ \eexp^{-rT} f(T;p_T)| \mathcal{F}_t} = \eexp^{-rt}f(t;p_t) 
\]

and the two approaches give the same result. \textbf{TODO not clear!}

\end{example}

\section{Dynamic Hedging: the Greeks}

The  operation   of  constructing   a  locally   risk-free  portfolio   like  in
Black-Scholes approach is an  \textit{hedging strategy}. The \textit{Greeks} are
quantities, named after the  fact that each of them is  indicated by a different
greek letter, which convey some information on the sensitivity of the price of a
derivative with respect  to some financial component of the  model (for example,
the price  or the volatility of  the underlying, or some  other parameter). Each
greek is actually a function of time, and  can thus be computed at any time $t$,
hence providing a form of \textit{dynamic hedging}.

\subsection{Delta}

The greek \textit{Delta}  measures the \textit{sensitivity} of the  price of the
derivative with respect to the underlying's price.

\[
  \Delta_t = \frac{\de f(t;S_t)}{\de S_t}
\]

\begin{example} 
  Let's calculate the Delta for an European call option. The call option price is
  \[
    C_t = S_t \mathcal{N}(d_1) - K\eexp^{-r(T-t)}\mathcal{N}(d_2)
    \quad
    \text{where} \quad
    \left\{ \begin{array}{c}
        d_1 = \frac{
          \ln\frac{S_t}{K} + \left(r + \frac{\sigma^2}{2}\right)(T-t)
        }{\sigma\sqrt{T-t}} \\
        d_2 = d_1 - \sigma\sqrt{T-t}
      \end{array}
  \]

  The Delta is the  quantity of underlying I need at time $t$  to hedge the risk
  in a  portfolio $\Pi_t  = \left\{ -1  \text{ option},  \frac{\de f(t;S_t)}{\de
  S_t} \text{ underlying}\right\} $.

  \[
    \Delta^C_t = \frac{\de C_t}{\de S_t} = \mathcal{N}(d_1)
  \]

  Notice that  the Delta for an  European call option is  always positive, which
  means that in the case of the  portfolio $\Pi_t$ the underlying will always be
  held in a long position.

  \textit{Proof.}  $S_t$ also  appears in  $d_1$ and  $d_2$, so  we can't  treat
  $\mathcal{N}(d_1)$ and $\mathcal{N}(d_2)$ as  constants; we must differentiate
  them w.r. $S_t$ too. For the chain rule,
  
  \[
    \frac{\de S_t\mathcal{N}(d_1)}{\de S_t} = \cancelto{1}{\frac{\de
    S_t}{\de S_t}} \mathcal{N}(d_1) + S_t \frac{\de \mathcal{N}(d_1)}{\de S_t}.
  \]

  So,

  \[
    \Delta^C_t = \mathcal{N}(d_1) + S_t\frac{\de \mathcal{N}(d_1)}{\de S_t} - K\eexp^{-r(T-t)} \frac{\de \mathcal{N}(d_2)}{\de S_t} 
  \]
  
  Compute the two partial derivatives appearing. First, the one for $\NN(d_1)$:
  \begin{align*}
    \frac{\de \NN(d_1)}{\de S_t} &= \frac{\de}{\de S_t} \int_{-\infty}^{d_1} \frac{\eexp^{-\frac{y^2}{2}}}{\sqrt{2\pi}} dy
    = \NN'(d_1) \frac{\de d_1}{\de S_t} - \NN'(-\infty)\cancelto{0}{\frac{\de (-\infty)}{\de S_t}}
    \\&= n(d_1)\frac{\de d_1}{\de S_t} = n(d_1) \cdot \frac{1}{\sigma\sqrt{T-t}}\frac{1}{\frac{S_t}{\cancel{K}}} \frac{1}{\cancel{K}}
    = \frac{n(d_1)}{S_t\sigma\sqrt{T-t}}
  \end{align*}

  Then, the one for $\NN(d_2)$:
  \begin{align*}
    \frac{\de \NN(d_2)}{\de S_t} &= n(d_2)\frac{\de d_2}{\de S_t} = n(d_2)\frac{\de (d_1 - \sigma\sqrt{T-t})}{\de S_t}
    \\&= n(d_2) \cdot \left( \frac{1}{\sigma\sqrt{T-t}} \frac{1}{\frac{S_t}{\cancel{K}}} \frac{1}{\cancel{K}} \right)
    = \frac{n(d_2)}{S_t\sigma\sqrt{T-t}}
  \end{align*}

  Now plug the results in the original equation for Delta:
  \begin{align*}
    \Delta^C_t = \NN(d_1) + S_t \frac{n(d_1)}{S_t\sigma\sqrt{T-t}} - K\eexp^{-r(T-t)}\frac{n(d_2)}{S_t\sigma\sqrt{T-t}}
  \end{align*}

  Isolate the two terms multiplying the gaussian density $n$:
  \begin{align*}
    & S_t \frac{n(d_1)}{S_t\sigma\sqrt{T-t}} - K\eexp^{-r(T-t)}\frac{n(d_2)}{S_t\sigma\sqrt{T-t}} =
    \\=& \frac{1}{S_t\sigma\sqrt{T-t}} \left( S_t n(d_1) - K\eexp^{-r(T-t)}n(d_2)\right) =
    \\=& \frac{1}{S_t\sigma\sqrt{T-t}} \left( \frac{S_t \eexp^{-\frac{d_1^2}{2}}}{\sqrt{2\pi}} 
    - \frac{K\eexp^{-r(T-t) -\frac{d_2^2}{2}}}{\sqrt{2\pi}}\right) =
    \\=& \frac{1}{S_t\sigma\sqrt{T-t}\sqrt{2\pi}} \left( S_t \eexp^{-\frac{d_1^2}{2}} - K\eexp^{-r(T-t) -\frac{d_2^2}{2}} \right) =
    \\=& \frac{1}{S_t\sigma\sqrt{T-t}\sqrt{2\pi}} \left( S_t \eexp^{-\frac{d_1^2}{2}} - K\eexp^{-r(T-t) - \frac{d_1^2}{2} - \frac{\sigma^2(T-t)}{2} + \frac{2}{2}d_1\sigma\sqrt{T-t}} \right) =
    \\=& \frac{\eexp^{-\frac{d_1^2}{2}}}{S_t\sigma\sqrt{T-t}\sqrt{2\pi}}\left( S_t - K\eexp^{-r(T-t) -\frac{\sigma^2(T-t)}{2} + d_1\sigma\sqrt{T-t}}\right) =
    \\=& \frac{\eexp^{-\frac{d_1^2}{2}}}{S_t\sigma\sqrt{T-t}\sqrt{2\pi}}\left( S_t - K\eexp^{\cancel{-r(T-t) -\frac{\sigma^2(T-t)}{2}} + \ln\frac{S_t}{K} + \cancel{\left( r + \frac{\sigma^2}{2}\right)(T-t)}}\right) =
    \\=& \frac{\eexp^{-\frac{d_1^2}{2}}}{S_t\sigma\sqrt{T-t}\sqrt{2\pi}}\left( S_t - K\eexp^{\ln\frac{S_t}{K}}\right)
    = \frac{\eexp^{-\frac{d_1^2}{2}}}{S_t\sigma\sqrt{T-t}\sqrt{2\pi}}\left( S_t - K\frac{S_t}{K}\right) =
    \\=& \frac{\eexp^{-\frac{d_1^2}{2}}}{S_t\sigma\sqrt{T-t}\sqrt{2\pi}}\cancel{\left( S_t - S_t\right)} = 0.
  \end{align*}

  We     have      proven     $S_t      \frac{n(d_1)}{S_t\sigma\sqrt{T-t}}     -
  K\eexp^{-r(T-t)}\frac{n(d_2)}{S_t\sigma\sqrt{T-t}} = 0$, so we finally get

  \[
    \Delta^C_t = \NN(d_1).
  \]
  \qed

\end{example}

Informally, Delta indicates how much to buy or sell to cover your portfolio.

\subsection{Gamma}

In  approximating the  derivative  price $f(t+dt;S_{t+dt})$  with a  first-order
Taylor expansion, that  is, hedging with the Delta, we  commit a \textit{hedging
error}, whose quantity is

\[
  \left(f(t;S_t) + \frac{\de f(t;S_t)}{\de S_t}\right) - f(t+dt;S_{t+dt}) 
\]

This represent  the quantity that  is not covered  by the hedging  strategy. The
magnitude  of  the hedging  error  depends  on how  much  the  concavity of  the
derivative curve  is stressed. By studying  the second order derivative,  we can
see how long  it takes for the hedging  error to get too large,  and thus decide
how often to buy and sell to rebuild the locally risk-free portfolio. The second
derivative of the  derivative price with respect to the  underlying price is the
Gamma:

\[
  \Gamma_t = \frac{\de^2 f(t;S_t)}{\de S_t^2} = \frac{\de \Delta_t}{\de S_t}
\]

For example, for the European call, we have:

\[
  \Gamma^C_t = \frac{\de C_t}{\de S_t^2} = \frac{\de \Delta^C_t}{\de S_t} = \frac{\de \NN(d_1)}{\de S_t} =
  \frac{n(d_1)}{S_t\sigma\sqrt{T-t}}.
\]

\subsection{Other Greeks}

Three other important Greeks are the Vega, the Rho and the Theta.

\[
  \begin{array}{rlr}
    \text{Vega}_t &= \frac{\de f(t;S_T)}{\de \sigma} & \text{Sensitivity w.r. to the volatility} \\
    \rho_t &= \frac{\de f(t;S_T)}{\de r} & \text{Sensitivity w.r. to the risk-free rate} \\
    \Theta_t &= \frac{\de f(t;S_T)}{\de t} & \text{Sensitivity w.r. to time} \\
  \end{array}
\]

These three Greeks allow you to hedge against model misspecifications instead of
risk; for example, Black-Scholes' considers both the volatility $\sigma$ and the
risk-free rate $r$ as constants, and this tends not to be true in reality.

For European call options, these three Greeks are

\[
  \text{Vega}^C_t = \frac{\de C_t}{\de\sigma} = S_t\sqrt{T-t} \cdot n(d_1)
\]
\[
  \rho^C_t = \frac{\de C_t}{\de r} = K(T-t)\eexp^{-r(T-t)}\NN(d_2)
\]
\[
  \Theta^C_t = \frac{\de C_t}{\de t} = -\frac{\sigma S_t n(d_1)}{2\sqrt{T-t}} - rK\eexp^{-r(T-t)}\NN(d_2)
\]

\subsection{Put-call parity}

The Greeks for  put options can be  calculated by being mindful  of the put-call
parity relationship:

\[
  \forall t \quad C_t + K\eexp^{-r(T-t)} = P_t + S_t
\]

Or, equivalently,

\[
  C_t = P_t + S_t - K\eexp^{-r(T-t)}
\]
\[
  P_t = C_t + K\eexp^{-r(T-t)} - S_t
\]

Then, the Greeks for European put options can be calculated as follows.

\subsubsection{Put Delta}

\[
  \Delta^P_t = \frac{\de P_t}{\de S_t} = \frac{\de C_t}{\de S_t} - \frac{\de S_t}{\de S_t} =
    \Delta^C_t - 1 = \NN(d_1) - 1 < 0
\]

For a  put option,  the Delta is  always negative, this  means that  the hedging
position should always be short.

\subsubsection{Put Gamma}

For a put option, the Gamma is identical to the case of a call option.

\[
  \Gamma^P_t = \frac{\de^2 P_t}{\de S_t^2} = \frac{\de \Delta^P_t}{\de S_t} =
  \frac{\de \Delta^C_t - 1}{\de S_t} = \frac{\de \Delta^C_t}{\de S_t} = \frac{n(d_1)}{S_t\sigma\sqrt{T-t}} \equiv \Gamma^C_t
\]

\subsubsection{Other Greeks for put options}

\[
  \text{Vega}^P_t = \frac{\de P_t}{\de \sigma} = S_t\sqrt{T-t}\cdot n(d_1) \equiv \text{Vega}^C_t
\]

\[
  \rho^P_t = \frac{\de P_t}{\de r} = -K(T-t)\eexp^{-r(T-t)} \NN(-d_2)
\]

\[
  \Theta^P_t = \frac{\de P_t}{\de t} = -\frac{\sigma S_t n(d_1)}{2\sqrt{T-t}} + rK\eexp^{-r(T-t)}\NN(-d_2)
\]

\begin{example}
  Suppose you  have to  sell an  European call  option whose  underlying, $S_t$,
  follows a Black-Scholes model. The following is known:

  \[
    S_0 = 8 \quad K = 8 \quad \mu = 20\% \quad \sigma = 40\% \quad r = 4\% \quad T = 1 \text{\ year}
  \]

  \textbf{(1)}. Determine  the number  of underlying to  buy/sell to  hedge this
  short position.

  We want  to create  a \textit{delta-neutral portfolio},  that is,  a portfolio
  where $\Delta = 0$. This way, risk is  removed since the rate of change of the
  portfolio value with respect to the price variation of the asset is zero.

  We know that 
  
  \[
    \Delta_0^C = \NN(d_1) = \NN\left(\frac{\ln\frac{8}{8} + \left(0.04 + \frac{0.4^2}{2}\right) \cdot 1}{0.4\sqrt{1}}\right)
    = \NN(0.3) = 0.618
  \]

  We can now impose the Delta for the portfolio $\pi = -1 \text{\ call option} +
  x \text{ stocks}$ to  be zero and solve the resulting equation  for $x$ to get
  the number of stocks the portfolio needs to have.

  \[
    \Delta^\pi = -1\cdot\Delta_0^C + x\cdot\overbrace{\Delta_0^{S}}^{\text{always }1} = 0 \implies
    x = \frac{\Delta^C_0}{\Delta^S_0} = \frac{0.618}{1} = 0.618
  \]

  This means that 0.618 units of stock must be bought to hedge one unit of short
  call option.  From this,  the Delta for  the put option  with same  strike and
  maturity as the call can be computed by put-call parity:

  \[
    \Delta_0^P = \Delta_0^C - 1 = 0.618 - 1 = -0.382
  \]

  \textbf{(2)}. Having a call option on the same underlying, but with strike $K'
  = 12$, construct a portfolio which is Delta- and Gamma-neutral.

  \[
    \Delta_0^{C'} = \NN(d'_1) = \NN\left(
      \frac{\ln\frac{8}{12} + \left(0.04+\frac{0.4^2}{2}\right)\cdot 1}{0.4\sqrt{1}}
    \right) = \NN(-0.71) = 0.238
  \]
  \[
    \Gamma_0^{C} = \frac{n(d_1)}{\sigma S_0\sqrt{T-t}} = 
    \frac{\frac{1}{\sqrt{2\pi}} \eexp^\frac{-(0.3)^2}{2}}{0.4 \cdot 8 \sqrt{1}} = 0.12
  \]
  \[
    \Gamma_0^{C'} = \frac{n(d'_1)}{\sigma S_0\sqrt{T-t}} = 
    \frac{\frac{1}{\sqrt{2\pi}} \eexp^\frac{-(-0.71)^2}{2}}{0.4 \cdot 8 \sqrt{1}} = 0.097
  \]

  To have a Gamma-neutral portfolio, we must solve for $y$ the equation

  \[
    \Gamma_0^\pi = -1 \cdot \Gamma_0^C + y\Gamma_0^{C'} + 0.618\cdot \overbrace{\Gamma_0^S}^{\text{always }0} = 0
    \implies y = \frac{\Gamma_0^C}{\Gamma_0^{C'}} = 1.237
  \]

  This means we  need to buy 1.237  units of the second call  option; but, doing
  this,  the portfolio  may  no  longer be  Delta-neutral,  since $\Delta^\pi  =
  1.237\Delta_0^{C'} \neq  0$. At  this point, we  start from  the Gamma-neutral
  portfolio of options and make it Delta-neutral again by imposing

  \[
    -1\cdot\Delta_0^C + 1.237\cdot\Delta_0^{C'} + x\Delta_0^S = 0
    \implies
    x = \Delta_0^C - 1.237\Delta_0^{C'} = 0.324
  \]

  Finally, selling one unit of the first  call option, buying 1.237 units of the
  second  call  option  and  0.324  units of  underlying  grants  a  Delta-  and
  Gamma-neutral portfolio.

\end{example}

\section{More Exotic options}

Exotic options are those generally not obeying Black-Scholes rules: their payoff
can be non-smooth and path dependent.  Non-smoothness for the pricing problem is
generally not a big problem. For example, the Digital option having payoff

\[
  D_T = \begin{cases} H & S_T\geq K \\ 0 & S_T<K \end{cases} = H\mathbbm{1}_{\{S_T\geq K\}}
\]

can be priced using risk neutral valuation:

\[
  D_t = \rnE{\eexp^{-r(T-t)}D_T\Big|\mathcal{F}_t} = H\eexp^{-r(T-t)}\mathbb{P}(S_T\geq K|\mathcal{F}_t)
  = H\eexp^{-r(T-t)}\NN(d_2)
\]

The hedging problem, instead, is trickier:

\begin{gather*}
  \Delta^D_t = \frac{\de D_t}{\de S_t} = H\eexp^{-r(T-t)}\cdot \frac{\de \NN(d_2)}{\de S_t} = (*)
\end{gather*}
\begin{gather*}
  \frac{\de \NN(d_2)}{\de S_t} = \frac{\de}{\de S_t}\int_{-\infty}^{d_2} \frac{\eexp^{-\frac{y^2}{2}}}{\sqrt{2\pi}}dy
  = n(d_2)\frac{\de d_2}{\de S_t} = \\
  = \frac{\eexp^{-\frac{\ln\frac{S_t}{k} + \left(r-\frac{\sigma^2}{2}\right)(T-t)^2}{2\sigma^2(T-t)}}}{\sqrt{2\pi}}
  \cdot \frac{1}{S_t\sigma\sqrt{T-t}}
\end{gather*}
\begin{gather*}
  (*) = \frac{H\eexp^{-r(T-t)}}{S_t\sigma\sqrt{T-t}\sqrt{2\pi}}\cdot\eexp^{-\frac{\ln\frac{S_t}{k} + \left(r-\frac{\sigma^2}{2}\right)(T-t)^2}{2\sigma^2(T-t)}}
\end{gather*}

As  $t \to  T$, $S_t  \to K$  and $\Delta^D_t  \to \infty$  which means  that an
infinite amount  of underlying should be  bought to hedge the  portfolio, and in
practice the hedge can't be done.

\subsection{Barrier options}

Path dependency means that the payoff depends on the process $(S_t)_{t \leq T}$.
Considering, for example, a payoff depending on the running minimum/running maximum
of the underlying's price. We must define two new processes

\[
  S_*(t) = \min\{S_u : 0 \leq u \leq t\} \quad\quad
  S^*(t) = \max\{S_u : 0 \leq u \leq t\}
\]

A \textit{barrier option} is an option that activates or loses value when the
underlying crosses a given price in a certain direction.

\begin{tabular}{p{.3\columnwidth}|p{.3\columnwidth}|p{.3\columnwidth}}
  & Up & Down \\
  \hline Knock-in & Activates when underlying price becomes $\geq c$ & Activates when underlying price becomes $\leq c$ \\
  \hline Knock-out & Deactivates when underlying price becomes $\geq c$& Deactivates when underlying price becomes $\leq c$
\end{tabular}

A   barrier   option    can   be   priced   using    risk   neutral   valuation.
For    example,    consider    a    barrier    in-up    call    having    payoff
$(S_T-K)^+\cdot\mathbbm{1}_{(S_*(t)\leq c)}$:

\begin{gather*}
  \text{Bar}_0 = \rnE{(S_T-K)^+\cdot\mathbbm{1}_{(S_*(t)\leq c)}}
  = \iint f(S_t,S_*(t)) \cdots \\= \left(\frac{c}{S_0}\right)^{\frac{2r}{\sigma^2}-1}
  C^E\left(\frac{c^2}{S_0},T,K\right)
\end{gather*}

where $C^E$ is the standard European call.

\subsection{Lookback options}

A lookback option gives you the right to pay or receive the minimum or maximum:
there is no fixed strike price.

\[
  L_T\equiv (S_T - S_*(t))
\]

This kind of option can be priced using risk neutral valuation.

\[
  L_0 = \rnE{\eexp^{-rT}(S_T-S_*(T))}
\]

\subsection{Asian options}

Asian options'  payoff depends  on an  average value  of the  underlying's price
during the life of the contract. If  a simple arithmetic average is used for the
payoff, such as

\[
  \left(\frac{1}{T} \int_0^T S_tdt - K\right)^+ \approx 
  \left(\frac{1}{n}\sum_{i=1}^{n} S_{t_i} -K\right)^+
\]

we don't have an analytical solution since $S_{t_i} \sim $ lognormal is unstable.
We can use, instead, a geometric average as a proxy for the arithmetic average,
giving a lower bound:

\[
  \left(\prod_{i=1}^n S_{t_i}\right)^{\frac{1}{n}} \implies
\]
\[
  \ln\left(\prod_{i=1}^n S_{t_i}\right)^{\frac{1}{n}} =
  \frac{1}{n}\ln\left(\prod_{i=1}^n S_{t_i}\right) =\frac{1}{n}\sum_{i=1}^{n} \ln S_{t_i}
  \leq \frac{1}{n}\sum_{i=1}^{n} S_{t_i} 
\]

\subsection{American options}

American options are  similar to European options but allow  early exercise. Let
$\tau$ be  the (random) stopping time;  for example, the payoff  for an American
put option  is is  $(K -  S_\tau)^+$. This  is difficult  to compute  using risk
neutral valuation:

\[
  \rnE{\eexp^{-r(T-t)} \max_\tau (K-S_\tau)^+}
\]

Partial differential equations, on the other hand, have no boundary in this case.

\chapter{Interest rate models}

Black-Scholes asset and  derivative pricing models assume the  interest rate for
the  considered time  interval  to be  constant. In  reality,  interest rate  is
subject to change in a stochastic way, similar to what happens for underlyings.

\subsection{Fundamental models}

The following are some of the  models used for modeling interest rate evolution.
Generally, the  deterministic factor indicates \textit{mean  reversion}, whereas
the  stochastic factor  is a  volatility similar  to Bachelier  or Black-Scholes
models.

\medskip

\begin{tabular}{p{.5\columnwidth}p{.5\columnwidth}}
{
  \textbf{Va\v{s}i\v{c}ek model}
  \[
    dr_t = a(b - r_t)dt + \sigma dW_t   
  \]
} & {
  \textbf{Cox-Ingersoll-Ross model}
  \[
    dr_t = a(b - r_t)dt + \sigma \sqrt{r_t}dW_t   
  \]
} \\
{
  \textbf{Dothran model}
  \[
    dr_t = a r_t dt + \sigma r_t dW_t
  \]
} & {
  \textbf{Ho-Lee model}
  \[
    dr_t = \Theta (t) dt + \sigma dW_t
  \]
} \\
{
  \textbf{Hull-White model}
  \[
    dr_t = a(t)(b(t) - r_t)dt + \sigma(t) dW_t
  \]
} & {
  \textbf{Generalized CIR model}
  \[
    dr_t = a(t)(b(t) - r_t)dt + \sigma(t)\sqrt{r_t}dW_t   
  \]
}
\end{tabular}

\subsection{Va\v{s}i\v{c}ek model}

\begin{theo}{\textbf{(Va\v{s}i\v{c}ek model is Gaussian)}}

\textit{Proof.} Use It\=o's Lemma to study the dynamics of $\eexp^{as}r_s$ where
$r_s$  follows a  Va\v{s}i\v{c}ek  model. Note  that the  model  can be  written
equivalently as $dr_t = -a(r_t-b)dt + \sigma dW_t$.

\begin{align*}
  d(\eexp^{as}r_s) &= a\eexp^{as}r_s ds + \eexp^{as}dr_s =
  a\eexp^{as}r_sds + \eexp^{as}\left( -a(r_s-b)ds + \sigma dW_s\right)
  \\&= \underbracket{\eexp^{as}ab}_\text{determ.}ds + \underbracket{\eexp^{as}\sigma}_\text{determ.} dW_s
\end{align*}

Now  compute  the   value  of  the  function  in  the   increment  $[0,t]$  and,
consequently, the value of the process at time $t$.

\begin{gather*}
  \eexp^{at}r_t - \eexp^{a\cdot 0}r_0 = \int_0^t ab\eexp^{as}ds + \int_0^t \eexp^{as}\sigma dW_s \implies \\
  \eexp^{at}r_t = r_0 + \left[b\eexp^{as}\right]^t_0 + \int_0^t \eexp^{as}\sigma dW_s \implies \\
  r_t = \eexp^{-at} r_0 + b\eexp^{-at}(\eexp^{at}-1) + \eexp^{-at} \int_0^t \eexp^{as}\sigma dW_s
\end{gather*}

The remaining integral  is with respect of  a function of time  and a stochastic
variable, and is thus a \textit{stochastic integral}; we study its distribution.

Let $h$ be a deterministic function, such that we can have $\int_0^t h(s)dW_s$.
For example, consider the \textit{step function} 

\[
  h(s) = \sum_{i=0}^{n-1} h_i \mathbbm{1}_{[t_i,t_{i+1}]}(s)
  \quad \text{s.t.} \quad
  \int_0^t h(s)dW_s \approx \sum_{i=0}^{n-1} h_i \left( W_{t_i+1} - W_{t_i} \right)
\]

Each of the Brownian motion increments in the summation is thus distributed like

\[
  W_{t_{i+1}} - W_{t_i} \sim \NN(0,t_{i+1}-t_i)} \equiv \NN(0,h^2_i(t_{i+1}-t_i))
\]

From the stability of the Gaussian distribution and the independence of Brownian
increments follows

\[
  X(W) = \int_0^t h(s)dW_s \sim \NN\left(0, \sum_{i=0}^{n-1} h^2_i(t_{i+1}-t_i)\right) \approx
  \NN\left(0, \int_0^t h^2(s)ds\right)
\]
\end{theo}

\subsection{Stochastic interest rates}

When interest  rates are  considered as being  stochastic, the  zero-coupon bond
price  $P(t,T)$ at  time $t$  with maturity  $T$ becomes  a stochastic  process,
varying  across the  \textit{term structure  of interest  rates} $\mathcal{T}  =
[T_1,T_2]$:

\[
  \left( \left(P(t,T)\right)_{t \in [0,T]}\right)_{T\in \mathcal{T}}
\]

The zero-coupon  bond behaves like  a derivative instrument whose  underlying is
the spot interest rate. The classical  approach to stochastic bond pricing is to
give an  exogenous model for the  spot interest rate $(r_t)_{t  \in [0,T]}$ and,
under no  arbitrage assumption, derive $\left(P(t,T)\right)_{t  \in [0,T]}$. Two
conditions imposed for this are:

\begin{itemize}
  \item $ P(T,T) = 1 $
  \item $ P(t_1,T) <P (t_2,T) \quad \text{for all} \quad t_1 < t_2 $
\end{itemize}

It has  been proved that,  under no  arbitrage assumption, the  discounted stock
price and  the discounted  european option  price are  \textit{martingales} with
respect to the risk neutral measure in $(\Omega,\mathcal{F},\mathbb{\tilde P})$:

\begin{align*}
  dS_t &= rS_tdt + \sigma S_t dW_t \implies\\
  d(\eexp^{-rt}S_t) &= -r\eexp^{-rt}S_tdt+ \eexp^{-rt}dS_t \\
                    &= -r\eexp^{-rt}S_tdt + \eexp^{-rt}\left(rS_tdt+\sigma S_t dW_t\right) \\
                    &= \eexp^{-rt}S_t\sigma dW_t \\
  d(\eexp^{-rt}f(t;S_t)) & = \frac{\de f}{\de S_t}\eexp^{-rt}\sigma S_t dW_t
\end{align*}

Let now $\hat{P}(t,T)$ and $P(t,T)$  be, respectively, the discounted bond price
and  the bond  price,  assume $(r_t)$  to  be  such that  $dr_t  = \mu(r_t)dt  +
\sigma(r_t)dW_t$. Hence,

\[
  \hat{P}(t,T) = \eexp^{-\int_0^T r(s)ds}P(t,T)
\]

(Note that,  if $r_t$  is supposed constant,  $\eexp^{-\int_0^T r(s)ds}  = rt$).
Impose now $\hat{P}$ to be a martingale:

\[
  \rnE{ \hat{P}(T,T) \Big| \mathcal{F}_t} = \hat{P}(t,T)\quad \forall t<T
\]

\[
  \rnE{ \eexp^{-\int_0^T r(s)ds}\hat{P}(T,T) \Big| \mathcal{F}_t} = \eexp^{-\int_0^T r(s)ds}\hat{P}(t,T)
\]

\[
  \eexp^{\int_0^t r(s)ds}\rnE{ \eexp^{-\int_0^T r(s)ds}\hat{P}(T,T) \Big| \mathcal{F}_t} = \hat{P}(t,T)
\]

The part  $\eexp^{\int_0^t r(s)ds}$ is  known at time $t$,  and can thus  be put
inside the expectation; moreover, $P(T,T)=1$ by definition:

\[
  P(t,T) = \rnE{ \eexp^{\int_0^tr(s)ds -\int_0^Tr(s)ds} \cdot 1 \Big| \mathcal{F}_t}
  = \rnE{\eexp^{-\int_t^T r(s)ds} \Big| \mathcal{F}_t}
\]

The bond price  is the expectation of  the payoff $1$ discounted  by the correct
factor, given the Brownian filtration at time $t$.

\subsection{Variance and covariance for Va\v{s}i\v{c}ek model}

It has been proved that Va\v{s}i\v{c}ek model is $\sim \NN(\cdot,\cdot)$, and
that the spot rate at time $t$ is given by

\[
  r_t = r_0 \eexp^{at}+b(1-\eexp^{-at}) + \sigma \eexp^{-at}\int_0^t\eexp^{as}dW_s
\]

It can be proven that the stochastic part is Gaussian:

\[
  \sigma\eexp^{-at} \int_0^t \eexp^{as}dW_s \sim \NN\left(0,\int_0^t\eexp^{2as}ds\right).
\]

With $h$ deterministic,

\[
  \int_0^t h(s)dW_s \approx \sum_{i=0}^{n-1} h_i \cdot (W_{t_{i+1}}-W_{t_i})
\]

and we can compute the variance as

\begin{gather*}
  \mathbb{E}\left[ \left( \sum_{i=0}^{n-1} h_i \left(W_{t_{i+1}} - W_{t_i} \right)\right)^2\right]
  = \\ = \mathbb{E}\left[ \sum_{i=0}^{n-1} h_i^2 \left(W_{t_{i+1}} - W_{t_i} \right)^2 \right]
  + \mathbb{E}\left[ \sum_{i\neq j} h_i h_j\left(W_{t_{i+1}} - W_{t_i} \right) \left(W_{t_{j+1}} - W_{t_j} \right)\right] =
  \\ = \mathbb{E}\left[ \sum_{i=0}^{n-1} h_i^2 \left(W_{t_{i+1}} - W_{t_i} \right)^2 \right]
  + \sum_{i \neq j} h_i h_j \cancelto{0}{\mathbb{E}\left[\left(W_{t_{i+1}} - W_{t_i} \right) \left(W_{t_{j+1}} - W_{t_j} \right)\right]} 
  \\ = \mathbb{E}\left[ \sum_{i=0}^{n-1} h_i^2 \left(W_{t_{i+1}} - W_{t_i} \right)^2 \right]
  =  \sum_{i=0}^{n-1} h_i^2 \mathbb{E}\left[ \left(W_{t_{i+1}} - W_{t_i} \right)^2 \right]
  \\ = \sum_{i=0}^{n-1} h_i^2 (t_{i+1}-t_i) \approx \int_0^t h^2(s)ds
\end{gather*}

The expectation for the spot rate is 

\begin{align*}
  \mathbb{E}\left[ r_t \right] &= \mathbb{E}\left[r_0 \eexp^{at}+b(1-\eexp^{-at}) + \sigma \eexp^{-at}\int_0^t\eexp^{as}dW_s\right]
  \\ &= r_0 \eexp^{at} + b(1-\eexp^{at}) + \cancelto{0}{\mathbb{E}\left[\sigma \eexp^{-at}\int_0^t\eexp^{as}dW_s\right]}
  \\ &= r_0 \eexp^{at} + b(1-\eexp^{at}) 
\end{align*}

This  means Va\v{s}i\v{c}ek  is  $\sim \NN(r_0  \eexp^{at}  + b(1-\eexp^{at})  ,
\cdot)$. Now,  compute the  \textit{autocovariance} (note:  $\mathrm{Cov}(X,Y) =
\mathbb{E}[XY] - \mathbb{E}[X]\mathbb{E}[Y]$):

\begin{align*}
  \mathrm{Cov}(r_t,r_{t+h}) &= \mathrm{Cov}\left(
    \sigma \eexp^{-at}\int_0^t\eexp^{as}dW_s,
    \sigma \eexp^{-a(t+h)}\int_0^{t+h}\eexp^{as}dW_s,
  \right)
  \\ &= \mathbb{E}\left[ 
    \sigma\eexp^{-at}\int_0^t\eexp^{as}dW_s \cdot
    \sigma\eexp^{-a(t+h)}\int_0^{t+h}\eexp^{as}dW_s
  \right] - 0
  \\ &= \sigma^2 \eexp^{-at-a(t+h)} \mathbb{E}\left[
    \int_0^t\eexp^{as}dW_s(\omega) \cdot
    \int_0^{t+h}\eexp^{as}dW_s(\omega) \cdot
  \right]
  \\ &= \sigma^2 \eexp^{-at-a(t+h)} \mathbb{E}\left[
    \int_0^t\eexp^{as}dW_s(\omega) \cdot \left(
      \int_0^{t}\eexp^{as}dW_s(\omega) +
      \int_t^{t+h}\eexp^{as}dW_s(\omega)
    \right)
  \right]
\end{align*}
\begin{align*}
  &= \sigma^2 \eexp^{-at-a(t+h)} \left(\mathbb{E}\left[
      \int_0^t \left(\eexp^{as}dW_s(\omega)\right)^2 
    \right] + \cancelto{0}{\mathbb{E}\left[
      \int_0^{t}\eexp^{as}dW_s(\omega) \cdot
      \int_t^{t+h}\eexp^{as}dW_s(\omega)
    \right]}
  \right)
  \\ &= \sigma^2 \eexp^{-at-a(t+h)} \mathbb{E}\left[
    \int_0^t \eexp^{2as}dW_s(\omega)
  \right] 
  = \sigma^2 \eexp^{-at-a(t+h)} \int_0^t \eexp^{2as}ds
  \\ &= \sigma^2 \eexp^{-2at-ah} \left[\frac{1}{2a}\eexp^{2av}\right]^t_0
  = \sigma^2\eexp^{-2at-ah} \cdot\frac{\eexp^{2at}-1}{2a}
\end{align*}

Finally,  we  can  assert  that,  with  $h  \to  0$,  Va\v{s}i\v{c}ek  model  is
distributed like

\[
  \sim \NN\left(
    r_0 \eexp^{-at}+b(1-\eexp^{-at}), \frac{\sigma^2\eexp^{-2at}(\eexp^{2at}-1)}{2a}
  \right)
\]

and the price of a zero-coupon bond depends on the parameters

\[
  P(t,T;\alpha) \quad \alpha = (a,b,\sigma).
\]

The theoretical term structure curve can be fitted with the observed data:

\[
  \left( P(0,T;\alpha)\right)_{T\in \mathcal{T}} \stackrel{\text{fit}}{\equiv}
  \left( P^*(0,T;\alpha)\right)_{T\in \mathcal{T}} 
\]

This is  very underdetermined;  instead of  using a model  as simple  as regular
Va\v{s}i\v{c}ek or Cox-Ingersoll-Ross,  we can use the  generalization of models
such as Hull-White,

\[
  dr_t = a(t)(b(t) - r_t)dt +\sigma(t)dW_t
\]

where  parameters in  the vector  $\alpha$ are  functions of  time, yielding  an
infinite class of parameters.

\subsection{A generic short rate model}

We want a generic, risk neutral model for the short rate. Let

\[
  dr(t) = \tilde{\mu}(t,r_t)dt + \sigma(t,r_t)d\tilde{W}_t
\]

be the  dynamics for our general  model, where $t$  is time and $r_t$  is state.
Then, the zero-coupon bond price is

\[
  P(t,T) = \rnE{\eexp^{-\int_t^T r(s)ds} \Big| \mathcal{F}_t}
\]

The  objective is  to find  $\tilde{\mu}$  in the  risk neutral  world with  the
information  coming from  the  real, \textit{historical}  world. So,  martingale
measures should be derived from the  market. Assume there are many maturities in
the market, and  there exist two zero-coupon bonds with  maturities $S$ and $T$,
whose underlying is the short rate:

\begin{gather*}
  P(t,S) \equiv F^S(t,r_t) \\
  P(t,T) \equiv F^T(t,r_t) \\
\end{gather*}

Now  give  a  model for  the  interest  rate.  Note  that $\mu$  and  $W_t$  are
historical, as opposed to the $\tilde{mu}$ and $\tilde{W}_t$ in the risk-neutral
world, but $\sigma$ is the same in both worlds.

\[
  dr_t = \mu(t,r_t)dt + \sigma(t,r_t)dW_t
\]

Apply It\=o's Lemma:

\begin{gather*}
  dF^S = F^S(\alpha_S dt + \sigma_S dW_t), \quad\quad
  dF^T = F^T(\alpha_T dt + \sigma_T dW_t) \\ 
  \text{where} \\
  \alpha_S = \frac{1}{F^S}\left(\frac{\de F^S}{\de t} + \frac{\de F^S}{\de r}\mu + \frac{1}{2}\frac{\de^2F^S}{\de r^2}\sigma^2\right) 
  \quad \text{drift for the bond price} \\
  \sigma_S = \frac{1}{F^S}\left(\frac{\de F^S}{\de r}\sigma \right) \quad\text{volatility for the bond price}
\end{gather*}

Now apply Black-Scholes. Construct a portfolio  with $h_S$ positions in the bond
with maturity $S$ and $h_T$ positions in the bond with maturity $T$:

\[
  V = h_S F^S + h_T F^T \quad\quad s.t. \quad\quad
  dV = h_S dF^S + h_T dF^T
\]

Let now

\[
  u_S \stackrel{def}{=} h_S \frac{F_S}{V} \quad\quad
  u_T \stackrel{def}{=} h_T \frac{F_T}{V} \quad\quad
  \text{s.t.}\quad\quad
  u_S+u_T = \frac{h_SF^S + h_TF^T}{V} = 1
\]

be  the percent  values of  each of  the bonds'  positions with  respect to  the
portfolio $V$. We can rewrite the dynamics for the portfolio as

\begin{align*}
  dV &= V\left( u_S \frac{dF^S}{F^S} + u_T \frac{dF^T}{F^T} \right)
  \\&= V(u_S(\alpha_Sdt + \sigma_S dW_t) + u_T(\alpha_Tdt + \sigma_T dW_t))
  \\&= V((u_S\alpha_S + u_T\alpha_T)dt + (u_S\sigma_S + u_T\sigma_T)dW_t)
\end{align*}

Then, impose the no arbitrage assumption to make the portfolio risk-free:

\begin{gather*}
  \begin{cases}
    u_S + u_T = 1 \\ u_S\sigma_S + u_T\sigma_T = 0
  \end{cases}
  \implies
  \begin{cases}
    u_S = 1 - u_T \\
    (1-u_T)\sigma_S + u_T\sigma_t = 0
  \end{cases}
  \implies \\
  \begin{cases}
    \\ \sigma_S - u_T(\sigma_S-\sigma_T) = 0
  \end{cases}
  \implies 
  \begin{cases}
    u_T = -\frac{\sigma_S}{\sigma_T - \sigma_S}\\
    u_S = \frac{\sigma_T}{\sigma_T - \sigma_S}
  \end{cases}
\end{gather*}

Holding the two  bonds in percent quantities of $u_S,u_T$,  the portfolio is now
risk free and the variation is deterministic.

\[
  dV = \cancel{V}(u_S\alpha_S + u_T\alpha_T)\cancel{dt} \stackrel{NAA}{=} r_t\cancel{V}\cancel{dt}
\]

This leads to the equation

\begin{gather*}
  u_S\alpha_S + u_T\alpha_T = r(t) \implies
  r(t) = \frac{\sigma_T}{\sigma_T - \sigma_S} \alpha_S - \frac{\sigma_S}{\sigma_T - \sigma_S} \alpha_T
  \implies\\
  r(t) = \frac{\sigma_T\alpha_S - \sigma_S\alpha_T}{\sigma_T - \sigma_S}
  \implies
  \sigma_T\alpha_S - \sigma_S\alpha_T = r(t) \cdot (\sigma_T - \sigma_S)
  \implies\\
  \frac{\alpha_S - r}{\sigma_S} = \frac{\alpha_T - r}{\sigma_T}
\end{gather*}

which means that, under no  arbitrage assumption, there is an \textit{exogenous}
coefficient which is invariant with respect to the market, called \textit{market
price of risk}, equal to the excess return divided by the volatility:

\[
  \lambda = \frac{\alpha_T - r}{\sigma_T}
\]

This coefficient  can be  estimated by using  the \textit{capital  asset pricing
model}. Multiplying by $\sigma_T$ we get $\alpha_S - r(t) = \lambda\sigma_S$ and
we can substitute $\alpha_S$ by its definition, to get

\begin{gather*}
  \frac{1}{F^S}\left(\frac{\de F^S}{\de t} + \frac{\de F^S}{\de r} \mu + 
  \frac{1}{2} \frac{\de^2 F^S}{\de r^2} \sigma^2 \right) - r = \lambda\frac{1}{F^S}\left(\frac{\de F^S}{\de r}\sigma\right)
  \implies\\
  \frac{\de F^S}{\de t} + \frac{\de F^S}{\de r}\mu + \frac{1}{2}\frac{\de^2 F^S}{\de r^2}\sigma^2 - rF^S = \lambda \frac{\de F^S}{\de r}\sigma
  \implies\\
  \frac{\de F^S}{\de t} + (\mu - \lambda\sigma)\frac{\de F^S}{\de r} + \frac{1}{2} \frac{\de^2 F^S}{\de r^2}\sigma^2 = rF^S
\end{gather*}

which  is  similar  to  the  boundary-free  Black-Scholes  partial  differential
equation. Imposing the condition $P(S,S)\equiv F^S(S,r_S)=1$ yields

\[
  dr(t) = (\mu - \lambda\sigma)dt + \sigma dW_t
\]

The drift part is exogenous and  defines which probability measure we are using;
the drift  $\tilde{\mu} =  \mu -  \lambda\sigma$ is the  one to  be used  in the
risk-neutral world.

\subsection{Affine term structures}

\begin{defn}{\textbf{(Affine short rate model).}}
  A short rate  model is \textit{affine} if the associated  term structure is of
  the form

  \[
    P(t,T) = \eexp^{A(t,T) -B(t,T)r_t}, \quad\quad A,B\quad\text{deterministic}
  \]
\end{defn}

Va\v{s}i\v{c}ek, CIR, Ho-Lee  and Hull-White are affine models. How  to derive A
and B? Let  $dr_t = \mu(t,r_t) dt  + \sigma(t,r_t)dW_t$ be a  generic short rate
model.

\begin{itemize}
  \item If 
    \begin{align*}
      \mu(t,T) = \alpha(t)r_t + \beta(t) &\quad \text{drift is affine} \\
      \sigma(t,T) = \sqrt{\gamma(t)r_t + \delta(t)} &\quad \text{volatility is affine}
    \end{align*}
    then $r_t$ is affine.
  \item Solve the Riccati equation to get $A$ and $B$.
    \begin{gather*}
      \begin{cases}
        \frac{\de B}{\de t} + \alpha(t)B - \frac{1}{2}\gamma(t)B^2(t,T) = -1
        \\
        \frac{\de A}{\de t} - \beta(t)B + \frac{1}{2} \delta(t)B^2(t,T) = 0
        \\ B(T,T) = 0
        \\ A(T,T) = 0
      \end{cases}
    \end{gather*}
    The last two equations are boundaries deriving from the fact that

    \[ P(T,T) \equiv \eexp^{A(T,T) - B(T,T)r_t} = 1 \]
\end{itemize}

\begin{example} Solution to Ho-Lee model.

  \[
    dr_t = \Theta(t)dt + \sigma dW_t \quad\quad r_t = r_0 \int_0^t \Theta(s)ds + \sigma dW_t
  \]

  First we prove this is an affine model. Let

  \begin{gather*}
    \alpha = 0 \quad\quad \beta = \Theta(t) \quad\quad \gamma = 0 \quad\quad \delta = \sigma^2
  \end{gather*}

  that shows Ho-Lee is affine. Now use the Riccati equations to find the values

  \begin{gather*}
    \begin{cases}
      \frac{\de B}{\de t} + 0 \cdot B -\frac{1}{2}\cdot0\cdot B^2(t,T) = -1 \\
      B(T,T) = 0 \\
      \frac{\de A}{\de t} - \Theta(t)B(t,T) + \frac{1}{2}\sigma^2B^2(t,T) = 0\\
      A(T,T) = 0
    \end{cases}
    \begin{cases}
      \frac{\de B}{\de t} = -1 \implies B(t,T) = (T-t) \\
      B(T,T) = 0 \\
      \frac{\de A}{\de t} - \Theta(t)(T-t) +\frac{1}{2}\sigma^2(T-t)^2 = 0\\
      A(T,T) = 0
    \end{cases} 
    \\
    \implies \frac{\de A}{\de t} = \Theta(T-t) - \frac{1}{2}\sigma^2(T-t)^2 \implies \\
    \int_t^T \frac{\de A}{\de s}ds = \int_t^T \Theta(T-s) - \frac{1}{2}\sigma^2(T-s)^2 ds \implies\\
    \cancelto{0}{A(T,T)} - A(t,T) = \int_t^T \Theta(T-s) - \frac{1}{2}\sigma^2(T-s)^2 ds \implies\\
    A(t,T) = -\int_t^T \Theta(T-s) - \frac{1}{2}\sigma^2(T-s)^2 ds
  \end{gather*}

  So, Ho-Lee's term structure is of the form

  \[
    P(t,T) = \eexp^{-\int_t^T \Theta(T-s) - \frac{1}{2}\sigma^2(T-s)^2 ds -(T-t)r_t}
  \]
\end{example}

\begin{example} Solution to Va\v{s}i\v{c}ek model.

  \[
    dr_t = a(b - r_t)dt + \sigma dW_t = (ab - ar_t)dt + \sigma dW_t
  \]

  The drift and the volatility are in a form such that

  \[
    \alpha(t) = -a \quad\quad \beta(t) = ab \quad\quad \gamma(t) = 0 \quad\quad \delta(t) = \sigma^2
  \]

  The Riccati equation yields

  \begin{gather*}
    B(t,T) = \frac{1}{a}\left( 1 - \eexp^{-a(T-t)}\right)\\
    A(t,T) = \frac{1}{a^2}\left( B(t,T)-T+t\right)\left(a^2b-\frac{\sigma^2}{2}\right) -\frac{1}{4a}\sigma^2B^2(t,T).
  \end{gather*}

\end{example}

\end{document}
